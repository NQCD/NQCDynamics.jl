<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fewest-switches surface hopping (FSSH) · NQCDynamics.jl</title><meta name="title" content="Fewest-switches surface hopping (FSSH) · NQCDynamics.jl"/><meta property="og:title" content="Fewest-switches surface hopping (FSSH) · NQCDynamics.jl"/><meta property="twitter:title" content="Fewest-switches surface hopping (FSSH) · NQCDynamics.jl"/><meta name="description" content="Documentation for NQCDynamics.jl."/><meta property="og:description" content="Documentation for NQCDynamics.jl."/><meta property="twitter:description" content="Documentation for NQCDynamics.jl."/><meta property="og:url" content="https://nqcd.github.io/NQCDynamics.jl/stable/dynamicssimulations/dynamicsmethods/fssh.html"/><meta property="twitter:url" content="https://nqcd.github.io/NQCDynamics.jl/stable/dynamicssimulations/dynamicsmethods/fssh.html"/><link rel="canonical" href="https://nqcd.github.io/NQCDynamics.jl/stable/dynamicssimulations/dynamicsmethods/fssh.html"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/citations.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../index.html"><img src="../../assets/logo.svg" alt="NQCDynamics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../index.html">NQCDynamics.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../index.html">Introduction</a></li><li><a class="tocitem" href="../../getting_started.html">Getting started</a></li><li><a class="tocitem" href="../../atoms.html">Atoms</a></li><li><a class="tocitem" href="../../ensemble_simulations.html">Ensemble simulations</a></li><li><a class="tocitem" href="../../saving_loading.html">Saving and loading</a></li><li><span class="tocitem">NQCModels.jl</span><ul><li><a class="tocitem" href="../../NQCModels/overview.html">NQCModels.jl</a></li><li><a class="tocitem" href="../../NQCModels/analyticmodels.html">Analytic model library</a></li><li><a class="tocitem" href="../../NQCModels/fullsizemodels.html">Full dimensional model library</a></li><li><a class="tocitem" href="../../NQCModels/frictionmodels.html">Electronic friction models</a></li><li><a class="tocitem" href="../../NQCModels/neuralnetworkmodels.html">MLIP Examples</a></li></ul></li><li><span class="tocitem">NQCDistributions.jl</span><ul><li><a class="tocitem" href="../../NQCDistributions/overview.html">NQCDistributions.jl</a></li></ul></li><li><span class="tocitem">Initial conditions</span><ul><li><a class="tocitem" href="../../initialconditions/ebk.html">Semiclassical EBK quantisation</a></li><li><a class="tocitem" href="../../initialconditions/hamiltonian.html">Thermal Hamiltonian Monte Carlo</a></li><li><a class="tocitem" href="../../initialconditions/langevin.html">Thermal Langevin dynamics</a></li><li><a class="tocitem" href="../../initialconditions/metropolishastings.html">Thermal Metropolis-Hastings Monte Carlo</a></li></ul></li><li><span class="tocitem">Dynamics simulations</span><ul><li><a class="tocitem" href="../dynamicssimulations.html">Introduction</a></li><li><a class="tocitem" href="classical.html">Classical molecular dynamics</a></li><li><a class="tocitem" href="ehrenfest.html">Ehrenfest molecular dynamics</a></li><li class="is-active"><a class="tocitem" href="fssh.html">Fewest-switches surface hopping (FSSH)</a><ul class="internal"><li><a class="tocitem" href="#Algorithm"><span>Algorithm</span></a></li><li><a class="tocitem" href="#Example"><span>Example</span></a></li></ul></li><li><a class="tocitem" href="langevin.html">Classical Langevin dynamics</a></li><li><a class="tocitem" href="mdef.html">Molecular dynamics with electronic friction (MDEF)</a></li><li><a class="tocitem" href="nrpmd.html">Nonadiabatic ring polymer molecular dynamics (NRPMD)</a></li><li><a class="tocitem" href="rpmd.html">Ring polymer molecular dynamics (RPMD)</a></li><li><a class="tocitem" href="rpsh.html">Ring polymer surface hopping (RPSH)</a></li></ul></li><li><span class="tocitem">Outputs and Analysis</span><ul><li><a class="tocitem" href="../../output_and_analysis/intro.html">Simulations outputs and analysis functions</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/reactive_scattering.html">Reactive scattering from a metal surface</a></li><li><a class="tocitem" href="../../examples/spinboson.html">Ohmic spin-boson nonequilibrium population dynamics</a></li><li><a class="tocitem" href="../../examples/threestatemorse.html">Time-dependent populations with the ThreeStateMorse model</a></li><li><a class="tocitem" href="../../examples/tully_scattering.html">Scattering probabilities for TullyModelTwo</a></li></ul></li><li><a class="tocitem" href="../../integration_algorithms.html">Integration algorithms</a></li><li><span class="tocitem">Developer documentation</span><ul><li><a class="tocitem" href="../../devdocs/diffeq.html">DifferentialEquations.jl integration</a></li><li><a class="tocitem" href="../../devdocs/models.html">Implementing a new model</a></li><li><a class="tocitem" href="../../devdocs/new_methods.html">Contributing a new method</a></li></ul></li><li><span class="tocitem">API</span><ul><li><input class="collapse-toggle" id="menuitem-14-1" type="checkbox"/><label class="tocitem" for="menuitem-14-1"><span class="docs-label">NQCBase</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/NQCBase/nqcbase.html">NQCBase</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-14-2" type="checkbox"/><label class="tocitem" for="menuitem-14-2"><span class="docs-label">NQCModels</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/NQCModels/adiabaticmodels.html">AdiabaticModels</a></li><li><a class="tocitem" href="../../api/NQCModels/cubeldfamodel.html">CubeLDFAModel</a></li><li><a class="tocitem" href="../../api/NQCModels/diabaticmodels.html">DiabaticModels</a></li><li><a class="tocitem" href="../../api/NQCModels/frictionmodels.html">FrictionModels</a></li><li><a class="tocitem" href="../../api/NQCModels/mace.html">MACE interface</a></li><li><a class="tocitem" href="../../api/NQCModels/nninterfaces.html">NNInterfaces</a></li><li><a class="tocitem" href="../../api/NQCModels/nonadiabaticmodels.html">NQCModels</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-14-3" type="checkbox"/><label class="tocitem" for="menuitem-14-3"><span class="docs-label">NQCDistributions</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/NQCDistributions/nqcdistributions.html">NQCDistributions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-14-4" type="checkbox"/><label class="tocitem" for="menuitem-14-4"><span class="docs-label">NQCDynamics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/NQCDynamics/analysis.html">Analysis</a></li><li><a class="tocitem" href="../../api/NQCDynamics/calculators.html">Calculators</a></li><li><a class="tocitem" href="../../api/NQCDynamics/dynamicsmethods.html">DynamicsMethods</a></li><li><a class="tocitem" href="../../api/NQCDynamics/dynamicsoutputs.html">DynamicsOutputs</a></li><li><a class="tocitem" href="../../api/NQCDynamics/dynamicsutils.html">DynamicsUtils</a></li><li><a class="tocitem" href="../../api/NQCDynamics/ensembles.html">Ensembles</a></li><li><a class="tocitem" href="../../api/NQCDynamics/estimators.html">Estimators</a></li><li><a class="tocitem" href="../../api/NQCDynamics/initialconditions.html">InitialConditions</a></li><li><a class="tocitem" href="../../api/NQCDynamics/nonadiabaticmoleculardynamics.html">NQCDynamics</a></li><li><a class="tocitem" href="../../api/NQCDynamics/numericutils.html">Numerical utilities</a></li><li><a class="tocitem" href="../../api/NQCDynamics/ringpolymers.html">RingPolymers</a></li><li><a class="tocitem" href="../../api/NQCDynamics/structure.html">Structure</a></li><li><a class="tocitem" href="../../api/NQCDynamics/timecorrelationfunctions.html">TimeCorrelationFunctions</a></li></ul></li></ul></li><li><a class="tocitem" href="../../references.html">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Dynamics simulations</a></li><li class="is-active"><a href="fssh.html">Fewest-switches surface hopping (FSSH)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="fssh.html">Fewest-switches surface hopping (FSSH)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/NQCD/NQCDynamics.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/NQCD/NQCDynamics.jl/blob/main/docs/src/dynamicssimulations/dynamicsmethods/fssh.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="fssh-dynamics"><a class="docs-heading-anchor" href="#fssh-dynamics">Fewest-switches surface hopping (FSSH)</a><a id="fssh-dynamics-1"></a><a class="docs-heading-anchor-permalink" href="#fssh-dynamics" title="Permalink"></a></h1><p>Tully&#39;s FSSH [<a href="../../references.html#Tully1990">1</a>] is one of the most popular methods for nonadiabatic molecular dynamics and is classified as a mixed-quantum classical method, where the nuclei are treated classically and the electrons are treated quantum mechanically.</p><p>The central concept that governs surface hopping methods is that the nuclei evolve on a single adiabatic potential energy surface at any given moment. At each timestep, a hopping probability is evaluated. If the hopping probability is larger than a uniform random number between 0 and 1, the active state is switched and the adiabatic propagation continues on the new electronic state. When this algorithm is applied to an ensemble of trajectories, the discrete adiabatic state  populations approximate the quantum mechanical populations for each state.</p><p>The surface hopping classical Hamiltonian can be written as</p><p class="math-container">\[H(t) = \frac{1}{2} \mathbf{P}^T \mathbf{M}^{-1} \mathbf{P} + \sum_i \delta(s(t) - i) E_i(\mathbf{R})\]</p><p>where <span>$\mathbf{P}$</span> is the vector of momenta, <span>$\mathbf{R}$</span> the positions, and <span>$\mathbf{M}$</span> the diagonal mass matrix. <span>$s(t)$</span> can be viewed as a digital signal that takes on the value of the currently occupied adiabatic state. As such, this Hamiltonian describes classical dynamics that proceeds under the influence of the potential <span>$E_i(\mathbf{R})$</span> when <span>$s(t) = i$</span>. The summation runs over all adiabatic states.</p><p>Of course, to integrate the associated equations of motion, <span>$s(t)$</span> must be obtained. This quantity is obtained stochastically for each trajectory by making probabilistic hops between surfaces. The probabilities are obtained by integrating the electronic Schrödinger equation alongside the dynamics as</p><p class="math-container">\[i\hbar \dot{c}_i(t) = E_i(\mathbf{R}) c_i (t)
- i\hbar \sum_j \dot{\mathbf{R}} \cdot \mathbf{d}_{ij}(\mathbf{R})c_j(t)\]</p><p>In this equation, <span>$c_i(t)$</span> are the complex coefficients for state <span>$i$</span> and <span>$\mathbf{d}_{ij}$</span> is the nonadiabatic coupling between adiabatic states <span>$i$</span> and <span>$j$</span>. The hopping probability is calculated as</p><p class="math-container">\[\gamma_{i \to j} = \sum_{\alpha} 2 \frac{P_\alpha}{M_\alpha}
\Re(\frac{\sigma_{ji}}{\sigma_{ii}}) d_{\alpha ij} dt.\]</p><p>At each timestep, a random number between 0 and 1 is generated which is compared to the probabilities. If the probability is higher than the random number, then a hop is attempted.</p><p>Additionally in the fewest-switches scheme, the energy is conserved for each trajectory by rescaling the momenta whenever a hop is performed. As such, when a hop is attempted, it will only be successful when there is sufficient kinetic energy for the energy to be conserved after the hop. If there is insufficient kinetic energy, this is termed a frustrated hop, and the dynamics proceeds without performing a hop. When a hop is successful, the kinetic energy is adjusted and <span>$s(t)$</span> takes on the value of the newly occupied state. For a more detailed description of the algorithm and the momentum rescaling procedure, please refer to [<a href="../../references.html#Subotnik2016">6</a>].  In this reference, the notion of reversing the momenta during frustrated hops is discussed. In our implementation we leave the frustrated trajectories unchanged, though it is suggested that the momentum reversal procedure may lead to better results in some cases.</p><h2 id="Algorithm"><a class="docs-heading-anchor" href="#Algorithm">Algorithm</a><a id="Algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Algorithm" title="Permalink"></a></h2><ol><li>Integrate classical dynamics for one timestep</li><li>Integrate electronic dynamics for one timestep</li><li>Evaluate hopping probability</li><li>Perform hop if sufficient probability and kinetic energy</li><li>Rescale velocity if hop is performed</li><li>Return to step 1</li></ol><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>With <code>DifferentialEquations.jl</code> we use a callback to perform the surface hopping procedure such that steps 1 and 2 are performed by the DifferentialEquations solvers and steps 3, 4, 5 are performed by the callback.</p></div></div><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>In this section we can investigate the results obtained for a single trajectory using FSSH.</p><p>First, the simulation parameters are created. Here, we have a single atom with a mass of <code>2000</code> a.u. and we are using Tully&#39;s third model ([<a href="../../references.html#Tully1990">1</a>]), provided by <a href="../../NQCModels/overview.html#NQCModels.jl">NQCModels.jl</a>.</p><pre><code class="language-julia hljs">using NQCDynamics

atoms = Atoms(2000)
sim = Simulation{FSSH}(atoms, TullyModelThree())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Simulation{FSSH{Float64}}:
  Atoms{Float64}([:X], [0], [2000.0])
  TullyModelThree{Float64, Float64, Float64}
  a: Float64 0.0006
  b: Float64 0.1
  c: Float64 0.9
</code></pre><p>The <a href="../../api/NQCDynamics/dynamicsmethods.html#NQCDynamics.DynamicsMethods.DynamicsVariables-Tuple{NQCDynamics.AbstractSimulation, Any, Any}"><code>DynamicsVariables</code></a> constructor has some extra arguments for FSSH. The first three match the classical case, but we also provide the initial state and whether we want this state to be <code>Adiabatic()</code> or <code>Diabatic()</code>. The type of state can be important when considering the ordering of the states. The adiabatic states are always arranged from lowest to highest energy, whereas the diabatic states will be ordered as defined in the model. You can inspect the fields of <code>u</code> to ensure the initialisation has proceeded as you intend.</p><pre><code class="language-julia hljs">u = DynamicsVariables(sim, [20/2000;;], [-10.;;], PureState(1, Adiabatic()))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10-element NQCDynamics.DynamicsMethods.SurfaceHoppingMethods.SurfaceHoppingVariables{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(v = ViewAxis(1:1, ShapedAxis((1, 1))), r = ViewAxis(2:2, ShapedAxis((1, 1))), σreal = ViewAxis(3:6, ShapedAxis((2, 2))), σimag = ViewAxis(7:10, ShapedAxis((2, 2))))}}, Int64} with indices 1:1:10:
   0.01
 -10.0
   1.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0</code></pre><p>Finally, the trajectory can be run by passing all the parameters we have set up so far. Here, we request both the <code>OutputDiscreteState</code> output which is equal to <span>$s(t)$</span> and  <code>OutputDiabaticPopulation</code>, which gives us the population of each diabatic state along the trajectory.</p><pre><code class="language-julia hljs">traj = run_dynamics(sim, (0.0, 2000.0), u, output=(OutputDiscreteState, OutputDiabaticPopulation))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Dictionaries.Dictionary{Symbol, Any}
                     :Time │ [0.0, 0.18908149053563247, 1.7674348775957727, 5.8…
      :OutputDiscreteState │ [1, 1, 1, 1, 1, 1, 1, 1, 1, 1  …  1, 1, 1, 1, 1, 1…
 :OutputDiabaticPopulation │ [[0.00010573020214217568, 0.9998942697978576], [0.…</code></pre><p>Now we can plot <span>$s(t)$</span> throughout the trajectory. The FSSH algorithm attempts to minimise the total number of hops; in the limit of infinite hops the result would tend to the mean-field (Ehrenfest) result, which is what FSSH attempts to avoid.</p><pre><code class="language-julia hljs">using Plots
plot(traj, :OutputDiscreteState)</code></pre><img src="fssh-9724c7f8.svg" alt="Example block output"/><p>Similarly, we can plot the diabatic populations. Since FSSH is performed in the adiabatic representation, even in the case of few hops, the diabatic populations can look dramatically different depending on the complexity of the model Hamiltonian. </p><pre><code class="language-julia hljs">plot(traj, :OutputDiabaticPopulation)</code></pre><img src="fssh-38d06ae8.svg" alt="Example block output"/><p><a href="../../examples/tully_scattering.html#examples-tully-model-two">Another example is available</a> where we use FSSH and other methods to reproduce some of the results from [<a href="../../references.html#Tully1990">1</a>].</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="ehrenfest.html">« Ehrenfest molecular dynamics</a><a class="docs-footer-nextpage" href="langevin.html">Classical Langevin dynamics »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Tuesday 16 July 2024 10:48">Tuesday 16 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
